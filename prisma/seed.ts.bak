// prisma/seed.ts

import { prisma } from "../src/lib/prisma";
import bcrypt from "bcryptjs";
import { citusers } from "../src/lib/citusers";
import { departments } from "../src/lib/departments";
import { links } from "../src/lib/links";
import { circularsByYear } from "../src/lib/circulars";
import { createClient } from "@supabase/supabase-js";
import * as fs from "fs";
import * as path from "path";

const SALT_ROUNDS = 10;

// Initialize Supabase client (for file storage)
const supabase = createClient(
  process.env.SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_KEY!
);

async function uploadFileToSupabase(localPath: string, destPath: string) {
  try {
    const fileBuffer = fs.readFileSync(localPath);
    const { data, error } = await supabase.storage
      .from(process.env.SUPABASE_BUCKET!)
      .upload(destPath, fileBuffer, {
        upsert: true,
        contentType: "application/pdf",
      });

    if (error) throw error;

    // Construct the public URL
    const { data: publicUrl } = supabase.storage
      .from(process.env.SUPABASE_BUCKET!)
      .getPublicUrl(destPath);

    console.log(`   -> Uploaded: ${publicUrl.publicUrl}`);
    return publicUrl.publicUrl;
  } catch (err: any) {
    console.error(`   -> Upload failed for ${destPath}:`, err.message);
    return null;
  }
}

async function main() {
  console.log("ðŸŒ± Starting intranet seed process (Supabase Edition)...");

  console.log("ðŸ§¹ Deleting old data...");
  await prisma.holidayYear.deleteMany({});
  await prisma.holidayMaster.deleteMany({});
  await prisma.link.deleteMany({});
  await prisma.department.deleteMany({});
  await prisma.circular.deleteMany({});

  console.log("ðŸ¢ Seeding Departments...");
  await prisma.department.createMany({
    data: departments.map((d) => ({ code: d.code, name: d.name })),
    skipDuplicates: true,
  });

  const allDepartments = await prisma.department.findMany();
  const departmentMap = new Map(
    allDepartments.map((d) => [d.code, d.id])
  );

  console.log("ðŸ‘¥ Upserting Users...");
  for (const u of Object.values(citusers)) {
    const departmentId = departmentMap.get(u.departmentCode);
    if (!departmentId) {
      console.warn(`Skipping user '${u.name}' â€“ unknown dept ${u.departmentCode}`);
      continue;
    }

    const passwordPlain = String(u.sailPNo ?? u.ticketNo);
    const hashedPassword = await bcrypt.hash(passwordPlain, SALT_ROUNDS);

    const role =
      String(u.ticketNo).startsWith("4") && u.departmentCode === 98500
        ? "admin"
        : "standard";

    const email =
      u.emailSail && u.emailSail !== "NOT AVAILABLE"
        ? u.emailSail
        : `${u.ticketNo}@saildsp.co.in`;

    await prisma.user.upsert({
      where: { ticketNo: String(u.ticketNo) },
      update: {},
      create: {
        name: u.name,
        ticketNo: String(u.ticketNo),
        role,
        designation: u.designation ?? "N/A",
        contactNo: u.mobileNo ?? null,
        sailPNo: u.sailPNo ?? null,
        email,
        password: hashedPassword,
        departmentId,
      },
    });
  }

  console.log("ðŸ”— Seeding Links...");
  await prisma.link.createMany({ data: links, skipDuplicates: true });

  console.log("ðŸ“„ Seeding Circulars (with Supabase uploads)...");
  const allCirculars = Object.values(circularsByYear).flat();

  for (const [index, circular] of allCirculars.entries()) {
    let fileUrl: string | null = null;

    if (index < 5) {
      console.log(` -> Uploading placeholder for: "${circular.headline}"`);
      const filePath = path.join(process.cwd(), "prisma/seed-assets/placeholder.pdf");
      const destPath = `circulars/placeholder_${circular.id}.pdf`;
      fileUrl = await uploadFileToSupabase(filePath, destPath);
    }

    await prisma.circular.create({
      data: {
        headline: circular.headline,
        publishedAt: new Date(circular.date),
        fileUrls: fileUrl ? [fileUrl] : [],
      },
    });
  }

  console.log("ðŸ“… Seeding HolidayMaster & HolidayYear samples...");

  await prisma.holidayMaster.createMany({
    data: [
      { name: "Republic Day", type: "CH" },
      { name: "Independence Day", type: "CH" },
      { name: "Christmas", type: "FH" },
      { name: "Bhai Dooj", type: "RH" },
    ],
    skipDuplicates: true,
  });

  const masters = await prisma.holidayMaster.findMany();
  const masterMap = new Map(masters.map((m) => [m.name, m.id]));

  await prisma.holidayYear.createMany({
    data: [
      {
        date: new Date("2025-01-26"),
        year: 2025,
        holidayType: "CH",
        holidayMasterId: masterMap.get("Republic Day")!,
      },
      {
        date: new Date("2025-08-15"),
        year: 2025,
        holidayType: "CH",
        holidayMasterId: masterMap.get("Independence Day")!,
      },
      {
        date: new Date("2025-12-25"),
        year: 2025,
        holidayType: "FH",
        holidayMasterId: masterMap.get("Christmas")!,
      },
      {
        date: new Date("2025-10-21"),
        year: 2025,
        holidayType: "RH",
        holidayMasterId: masterMap.get("Bhai Dooj")!,
      },
    ],
    skipDuplicates: true,
  });

  console.log("âœ… Seeding complete (Supabase Edition).");
}

main()
  .catch(async (e) => {
    console.error("âŒ Error during seed process:", e);
    await prisma.$disconnect();
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });
